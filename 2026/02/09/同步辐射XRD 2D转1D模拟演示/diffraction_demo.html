<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realistic Calibration Demo</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script>
    // Á¶ÅÁî®Âè≥ÈîÆËèúÂçï
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        return false;
    });

    // Á¶ÅÁî®Â∏∏ËßÅÂø´Êç∑ÈîÆ
    document.addEventListener('keydown', function(e) {
        // F12
        if (e.key === 'F12') {
            e.preventDefault();
            return false;
        }
        // Ctrl+Shift+I (Chrome/Edge)
        if (e.ctrlKey && e.shiftKey && e.key === 'I') {
            e.preventDefault();
            return false;
        }
        // Ctrl+Shift+J (Chrome)
        if (e.ctrlKey && e.shiftKey && e.key === 'J') {
            e.preventDefault();
            return false;
        }
        // Ctrl+Shift+C (Chrome)
        if (e.ctrlKey && e.shiftKey && e.key === 'C') {
            e.preventDefault();
            return false;
        }
        // Ctrl+U (Êü•ÁúãÊ∫ê‰ª£Á†Å)
        if (e.ctrlKey && e.key === 'u') {
            e.preventDefault();
            return false;
        }
        // Ctrl+S (‰øùÂ≠ò)
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            return false;
        }
    });
    </script>
    <style>
        :root {
            --bg-color: #0b0c10;
            --panel-bg: #1f2833;
            --input-bg: #2b3540;
            --text-color: #c5c6c7;
            --accent: #66fcf1;
            --accent-dim: #45a29e;
            --danger: #ff5252;
            --success: #66ff66;
            --warning: #ffdb58;
            --border: #45a29e;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* --- Header & Tabs --- */
        header {
            background-color: var(--panel-bg);
            padding: 0 20px;
            border-bottom: 2px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            height: 60px; flex-shrink: 0;
        }
        
        .tab-container { display: flex; height: 100%; gap: 5px; align-items: flex-end; }
        
        .tab-btn {
            background: transparent; border: none; color: #888; 
            padding: 15px 20px; font-size: 1rem; font-weight: 600; cursor: pointer;
            border-bottom: 3px solid transparent; transition: all 0.2s;
        }
        .tab-btn:hover { color: #fff; }
        .tab-btn.active { color: #fff; border-bottom-color: var(--accent); background: rgba(102, 252, 241, 0.05); }

        button.lang-btn {
            background: transparent; border: 1px solid var(--accent-dim); color: var(--accent-dim); 
            padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 0.75rem;
        }
        button.lang-btn:hover { background: var(--accent-dim); color: var(--bg-color); }

        /* --- Layout --- */
        .main-container { display: none; flex: 1; overflow: hidden; } /* Hidden by default */
        .main-container.active-view { display: flex; }

        .sidebar {
            width: 340px; background-color: #15191d; border-right: 1px solid #333;
            padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; flex-shrink: 0;
        }

        .workspace {
            flex: 1; display: flex; flex-direction: column; background: #000; position: relative;
        }

        /* --- UI Components --- */
        .control-section {
            background: rgba(255,255,255,0.03); padding: 12px;
            border-radius: 4px; border-left: 3px solid var(--accent-dim);
        }
        .section-title {
            font-size: 0.75rem; font-weight: 800; color: var(--accent-dim);
            margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;
        }
        label { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85rem; color: #fff; }
        select, input[type="number"] {
            width: 100%; background: var(--input-bg); border: 1px solid #455a64; color: #fff;
            padding: 8px; border-radius: 4px; margin-bottom: 10px; font-size: 0.9rem; outline: none;
        }
        input[type="range"] { width: 100%; cursor: pointer; margin: 10px 0; accent-color: var(--accent); }
        
        button.action-btn {
            width: 100%; background-color: var(--accent-dim); color: var(--bg-color); border: none;
            padding: 10px; cursor: pointer; border-radius: 4px; font-size: 0.9rem; font-weight: 700;
            transition: all 0.2s; margin-top: 5px;
        }
        button.action-btn:hover { background-color: var(--accent); box-shadow: 0 0 10px var(--accent); }

        .value-display { font-family: 'Courier New', monospace; color: var(--accent); font-weight: bold; }

        /* --- Canvas --- */
        .canvas-area {
            flex: 1; display: flex; justify-content: center; align-items: center;
            background: #000; position: relative; overflow: hidden; cursor: crosshair;
        }
        canvas { max-width: 100%; max-height: 100%; object-fit: contain; box-shadow: 0 0 50px rgba(0,255,255,0.05); }

        /* --- Markers --- */
        #beamCenterMarker {
            position: absolute; width: 30px; height: 30px; transform: translate(-50%, -50%);
            pointer-events: none; z-index: 10;
        }
        #beamCenterMarker::before, #beamCenterMarker::after {
            content: ''; position: absolute; background: var(--danger); box-shadow: 0 0 4px #000;
        }
        #beamCenterMarker::before { top: 14px; left: 0; width: 30px; height: 2px; }
        #beamCenterMarker::after { left: 14px; top: 0; width: 2px; height: 30px; }

        /* --- Plot --- */
        .plot-area {
            height: 35vh; background: var(--panel-bg); border-top: 1px solid #333; padding: 5px; z-index: 20;
        }

        /* --- Calibration Specific --- */
        .math-box {
            background: #000; padding: 10px; border: 1px solid #333; 
            font-family: 'Courier New', monospace; color: #fff; font-size: 0.85rem; margin-top: 10px;
        }
        .math-var { color: var(--accent); }
        
        .error-panel {
            margin-top: 10px; padding: 10px; border-radius: 4px; background: rgba(0,0,0,0.3); border: 1px solid #444;
        }
        .error-label { font-size: 0.75rem; color: #888; text-transform: uppercase; }
        .error-value { font-size: 1.2rem; font-weight: bold; font-family: monospace; }
        .status-good { color: var(--success); }
        .status-warn { color: var(--warning); }
        .status-bad { color: var(--danger); }

        #legend {
            position: absolute; bottom: 10px; left: 10px; 
            background: rgba(0,0,0,0.8); padding: 8px; border-radius: 4px; font-size: 0.8rem; pointer-events: none;
        }
        .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; }

    </style>
</head>
<body>

<header>
    <div class="tab-container">
        <button class="tab-btn active" onclick="switchTab('sim')" id="tabSim">Experiment Simulation</button>
        <button class="tab-btn" onclick="switchTab('calib')" id="tabCalib">Multi-Ring Calibration</button>
    </div>
    <button class="lang-btn" onclick="toggleLang()">‰∏≠Êñá / English</button>
</header>

<div class="main-container active-view" id="viewSim">
    <div class="sidebar">
        <div class="control-section">
            <div class="section-title" id="secSource">Beam & Sample</div>
            <label><span id="lblWavelength">Wavelength</span></label>
            <select id="wavelengthSelect" onchange="updateSim()">
                <option value="1.5418">Cu KŒ± (1.54 √Ö / 8 keV)</option>
                <option value="0.7107">Mo KŒ± (0.71 √Ö / 17 keV)</option>
                <option value="0.1240" selected>High Energy (0.124 √Ö / 100 keV)</option>
            </select>
            <label><span id="lblSample">Sample</span></label>
            <select id="sampleSelect" onchange="updateSim()">
                <option value="lab6">LaB6 (Standard)</option>
                <option value="au">Gold (Au) Nano</option>
                <option value="glass">Silica Glass</option>
            </select>
        </div>

        <div class="control-section">
            <div class="section-title" id="secDetector">Detector</div>
            <label><span id="lblResolution">Resolution</span></label>
            <select id="resSelect" onchange="handleResChange()">
                <option value="256">256 x 256 (Fast)</option>
                <option value="512">512 x 512 (Standard)</option>
                <option value="1024" selected>1024 x 1024 (High Res)</option>
            </select>
            <label><span id="lblPixelSize">Pixel Size</span></label>
            <select id="pixelSizeSelect" onchange="updateSim()">
                <option value="0.200" selected>200 Œºm (Flat Panel)</option>
                <option value="0.075">75 Œºm (Eiger)</option>
            </select>
            <label>
                <span id="lblSDD">SDD (Distance)</span>
                <span class="value-display" id="sddVal">1000 mm</span>
            </label>
            <input type="range" id="sddRange" min="200" max="2500" value="1000" step="10" oninput="updateSim()">
        </div>

        <div class="control-section">
            <div class="section-title" id="secProcessing">Processing</div>
            <button class="action-btn" onclick="resetSimCenter()" id="btnReset">Auto-Calibrate Center</button>
            <div class="tooltip" id="tipDrag">‚ö†Ô∏è Drag Crosshair to simulate misalignment.</div>
        </div>
    </div>

    <div class="workspace">
        <div class="canvas-area" id="simCanvasContainer">
            <canvas id="simCanvas"></canvas>
            <div id="beamCenterMarker"></div>
            <div style="position:absolute; top:10px; right:10px; color:#66fcf1; font-family:monospace; pointer-events:none;">Mode: Simulation</div>
        </div>
        <div class="plot-area" id="plotDiv"></div>
    </div>
</div>

<div class="main-container" id="viewCalib">
    <div class="sidebar">
        <div class="control-section">
            <div class="section-title" id="calibGoalTitle">Mission Goal</div>
            <p id="calibDesc" style="font-size: 0.85rem; color: #ccc; margin:0 0 10px 0;">
                The detector distance is unknown. Adjust the fit to align the 5 inner rings to the data.
            </p>
            <button class="action-btn" onclick="startNewCalibration()" id="btnNewProblem">
                üé≤ Generate New Problem
            </button>
        </div>

        <div class="control-section">
            <div class="section-title" id="calibStepTitle">Refinement</div>
            <label>
                <span id="lblSlider">Adjust Fit (Scale)</span>
            </label>
            
            <input type="range" id="calibRadiusSlider" min="10" max="500" value="100" step="0.1" oninput="drawCalibScene()">
            
            <div class="error-panel">
                <div style="display:flex; justify-content:space-between; align-items:end;">
                    <div class="error-label">RMSE (Error)</div>
                    <div class="error-value status-bad" id="rmseVal">--</div>
                </div>
                <div style="font-size:0.7rem; color:#666; margin-top:4px;" id="rmseDesc">Target: < 1.0 px</div>
            </div>

            <div class="math-box">
                <div>Fit Rings (hkl): 100, 110, 111, 200, 210</div>
                <hr style="border-color:#333">
                Current Calc SDD: <br>
                <span class="math-var" id="mathRes" style="font-size:1.1rem; font-weight:bold;">---</span> mm
            </div>
        </div>

        <div class="control-section">
            <button class="action-btn" style="background:var(--success); color:#000;" onclick="checkCalibration()" id="btnCheck">
                ‚úî Verify Distance
            </button>
            <div id="calibFeedback" style="margin-top:10px; text-align:center;"></div>
        </div>
    </div>

    <div class="workspace">
        <div class="canvas-area" id="calibCanvasContainer">
            <canvas id="calibCanvas"></canvas>
            <div id="legend">
                <div class="legend-item"><div class="dot" style="background:#ff5252;"></div> Data (11 Rings)</div>
                <div class="legend-item"><div class="dot" style="background:#66ff66;"></div> Fit (5 Rings)</div>
            </div>
            <div style="position:absolute; top:10px; right:10px; color:var(--success); font-family:monospace; pointer-events:none;">Mode: Calibration</div>
        </div>
    </div>
</div>

<script>
    // --- CONSTANTS ---
    // Full LaB6 Peaks (11 rings)
    const LaB6_D = [
        4.156, 2.939, 2.399, 2.078, 1.859, 
        1.697, 1.469, 1.385, 1.314, 1.253, 
        1.200
    ]; 

    const Au_D = [2.355, 2.039, 1.442, 1.230];
    const SiO2_D = [4.0, 1.2];

    let LANG = 'en';

    // Simulation State
    const SIM = {
        lambda: 0.1240, pixelSize: 0.200, sdd: 1000, res: 1024,
        sample: 'lab6', bcX: 512, bcY: 512
    };

    // Calibration State
    const CALIB = {
        realSDD: 0,
        lambda: 0.1240,
        pixelSize: 0.200,
        res: 800
    };

    // --- DOM ---
    const simCanvas = document.getElementById('simCanvas');
    const simCtx = simCanvas.getContext('2d', { alpha: false });
    const calibCanvas = document.getElementById('calibCanvas');
    const calibCtx = calibCanvas.getContext('2d', { alpha: false });
    const marker = document.getElementById('beamCenterMarker');

    // --- LOCALIZATION ---
    const TXT = {
        en: {
            tabSim: "Experiment Simulation", tabCalib: "Multi-Ring Calibration",
            secSource: "Beam & Sample", lblWavelength: "Wavelength", lblSample: "Sample",
            secDetector: "Detector", lblResolution: "Resolution", lblPixelSize: "Pixel Size", lblSDD: "SDD (Distance)",
            btnReset: "Auto-Calibrate Center", tipDrag: "‚ö†Ô∏è Drag Crosshair to simulate misalignment.",
            calibGoalTitle: "Mission Goal", calibDesc: "The detector distance is unknown. Adjust the fit to align the 5 visible green rings to the data.",
            btnNewProblem: "üé≤ Generate New Problem", calibStepTitle: "Refinement",
            lblSlider: "Adjust Fit (Scale)", btnCheck: "‚úî Verify Distance",
            rmseDesc: "Target: < 1.0 px (Root Mean Square Error)",
            legendData: "Data (11 Rings)", legendFit: "Fit (First 5 Rings)"
        },
        cn: {
            tabSim: "Ë°çÂ∞ÑÂÆûÈ™åÊ®°Êãü", tabCalib: "Â§öÁéØÊ†áÂÆö (5ÁéØÊãüÂêà)",
            secSource: "ÂÖâÊ∫ê‰∏éÊ†∑ÂìÅ", lblWavelength: "Ê≥¢Èïø/ËÉΩÈáè", lblSample: "Ê†∑ÂìÅÊùêÊñô",
            secDetector: "Êé¢ÊµãÂô®ËÆæÁΩÆ", lblResolution: "ÂàÜËæ®Áéá", lblPixelSize: "ÂÉèÁ¥†Â∞∫ÂØ∏", lblSDD: "Ê†∑ÂìÅË∑ùÁ¶ª (SDD)",
            btnReset: "Ëá™Âä®Ê†°ÂáÜÂÖâÊùü‰∏≠ÂøÉ", tipDrag: "‚ö†Ô∏è ÊãñÂä®ÂçÅÂ≠óÊ®°ÊãüÂÖâÊùü‰∏≠ÂøÉÂÅèÁßª",
            calibGoalTitle: "Ê†áÂÆö‰ªªÂä°", calibDesc: "Êé¢ÊµãÂô®Ë∑ùÁ¶ªÊú™Áü•„ÄÇËØ∑Ë∞ÉÊï¥ÂèÇÊï∞Ôºå‰Ωø5‰∏™ÁªøËâ≤ÊãüÂêàÁéØ‰∏éÁ∫¢Ëâ≤Êï∞ÊçÆÁéØÁöÑÂÜÖÂúàÈáçÂêà„ÄÇ",
            btnNewProblem: "üé≤ ÁîüÊàêÊñ∞ÁöÑÊú™Áü•Ë∑ùÁ¶ª", calibStepTitle: "Á≤æ‰øÆÂèÇÊï∞",
            lblSlider: "Ë∞ÉÊï¥ÊãüÂêà (Áº©Êîæ)", btnCheck: "‚úî È™åËØÅËÆ°ÁÆóÁªìÊûú",
            rmseDesc: "ÁõÆÊ†á: < 1.0 px (ÂùáÊñπÊ†πËØØÂ∑Æ RMSE)",
            legendData: "ÁúüÂÆûÊï∞ÊçÆ (11ÁéØ)", legendFit: "ÊãüÂêàÊ®°Âûã (Ââç5ÁéØ)"
        }
    };

    // ================== SHARED PHYSICS ==================
    function calculateRingRadius(d, lambda, sdd, pixSize) {
        if (lambda > 2 * d) return null;
        const theta = Math.asin(lambda / (2 * d));
        const r_mm = sdd * Math.tan(2 * theta);
        return r_mm / pixSize;
    }

    // ================== SIMULATION LOGIC ==================
    function drawSimPattern() {
        let res = SIM.res;
        if (isDragging && SIM.res > 512) res = 512;
        if (simCanvas.width !== res) { simCanvas.width = res; simCanvas.height = res; }
        const scale = res / SIM.res;

        simCtx.fillStyle = '#050505'; simCtx.fillRect(0, 0, res, res);
        const imgData = simCtx.getImageData(0, 0, res, res);
        const data = imgData.data;

        let d_list = SIM.sample === 'lab6' ? LaB6_D : (SIM.sample === 'au' ? Au_D : SiO2_D);
        let type = SIM.sample === 'glass' ? 'amorphous' : 'cryst';

        const rings = [];
        d_list.forEach((d, i) => {
            const r = calculateRingRadius(d, SIM.lambda, SIM.sdd, SIM.pixelSize);
            if (r) {
                const r_render = r * scale;
                let w = (type === 'amorphous' ? 40 : 2.5) * scale;
                if (r_render < res * 1.5) rings.push({r: r_render, int: 250/(1+i*0.3), w: w});
            }
        });

        const cx = res/2, cy = res/2;
        for (let y=0; y<res; y++) {
            const dy = y - cy; const dy2 = dy*dy;
            for (let x=0; x<res; x++) {
                const dist = Math.sqrt((x-cx)**2 + dy2);
                let val = 2 + Math.random()*2;
                for (let r of rings) {
                    const diff = Math.abs(dist - r.r);
                    if (diff < r.w*4) val += r.int * Math.exp(-(diff*diff)/(2*r.w*r.w));
                }
                const idx = (y*res + x)*4;
                val = Math.min(255, val);
                data[idx] = val*0.8; data[idx+1] = val; data[idx+2] = val; data[idx+3] = 255;
            }
        }
        simCtx.putImageData(imgData, 0, 0);
        
        simCtx.beginPath(); simCtx.arc(cx, cy, 8*scale, 0, Math.PI*2);
        simCtx.fillStyle = '#000'; simCtx.fill(); simCtx.strokeStyle = '#222'; simCtx.stroke();
    }

    function integrateSim() {
        const res = simCanvas.width;
        const scale = SIM.res / res;
        const maxR = Math.sqrt(res**2 + res**2); 
        const max2Theta = Math.atan((maxR * scale * SIM.pixelSize) / SIM.sdd) * 180/Math.PI;
        
        // High Res Integration
        const nBins = 3000; 
        
        const yData = new Float32Array(nBins).fill(0);
        const count = new Uint32Array(nBins).fill(0);
        const step = max2Theta / nBins;

        const img = simCtx.getImageData(0,0,res,res).data;
        const usrCx = SIM.bcX / scale;
        const usrCy = SIM.bcY / scale;

        const pixStep = (res > 800 && !isDragging) ? 2 : 1;

        for(let y=0; y<res; y+=pixStep) {
            const dy = y - usrCy;
            for(let x=0; x<res; x+=pixStep) {
                const r_pix = Math.sqrt((x-usrCx)**2 + dy*dy);
                if(r_pix < 5) continue;
                const twoTh = Math.atan((r_pix * scale * SIM.pixelSize)/SIM.sdd) * 180/Math.PI;
                const bin = Math.floor(twoTh / step);
                if(bin < nBins) {
                    yData[bin] += img[(y*res+x)*4+1];
                    count[bin]++;
                }
            }
        }

        const xs = [], ys = [];
        for(let i=0; i<nBins; i++) {
            if(count[i]>0) { xs.push(i*step); ys.push(yData[i]/count[i]); }
        }
        
        Plotly.react('plotDiv', [{ x: xs, y: ys, mode: 'lines', line: {color: '#66fcf1', width: 1.0}, fill:'tozeroy', fillcolor:'rgba(102,252,241,0.1)' }], {
            paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)',
            margin:{t:20,b:30,l:50,r:10}, font:{color:'#888'},
            xaxis:{title: '2-Theta (deg)', color: '#ccc', gridcolor:'#333'},
            yaxis:{title: 'Intensity', color: '#ccc', gridcolor:'#333'}
        }, {displayModeBar: false});
    }

    // Sim Interaction
    function updateSim() {
        SIM.lambda = parseFloat(document.getElementById('wavelengthSelect').value);
        SIM.pixelSize = parseFloat(document.getElementById('pixelSizeSelect').value);
        SIM.sdd = parseInt(document.getElementById('sddRange').value);
        SIM.sample = document.getElementById('sampleSelect').value;
        document.getElementById('sddVal').innerText = SIM.sdd + ' mm';
        drawSimPattern(); integrateSim(); updateMarker();
    }
    
    let isDragging = false;
    document.getElementById('simCanvasContainer').addEventListener('mousedown', (e) => { isDragging = true; handleDrag(e); });
    window.addEventListener('mousemove', (e) => { if(isDragging) handleDrag(e); });
    window.addEventListener('mouseup', () => { if(isDragging) { isDragging = false; drawSimPattern(); integrateSim(); } });
    function handleDrag(e) {
        const rect = simCanvas.getBoundingClientRect();
        SIM.bcX = ((e.clientX - rect.left)/rect.width) * SIM.res;
        SIM.bcY = ((e.clientY - rect.top)/rect.height) * SIM.res;
        updateMarker(); drawSimPattern(); integrateSim();
    }
    function updateMarker() { marker.style.left = (SIM.bcX/SIM.res*100)+'%'; marker.style.top = (SIM.bcY/SIM.res*100)+'%'; }
    function handleResChange() { SIM.res = parseInt(document.getElementById('resSelect').value); resetSimCenter(); }
    function resetSimCenter() { SIM.bcX = SIM.res/2; SIM.bcY = SIM.res/2; updateSim(); }


    // ================== CALIBRATION LOGIC ==================

    function startNewCalibration() {
        CALIB.realSDD = Math.floor(Math.random() * 1200) + 600; 
        document.getElementById('calibFeedback').innerHTML = "";
        
        // Reset slider to something wrong
        const firstRingPix = calculateRingRadius(LaB6_D[0], CALIB.lambda, CALIB.realSDD, CALIB.pixelSize);
        document.getElementById('calibRadiusSlider').value = firstRingPix * 0.8; 
        
        drawCalibScene();
    }

    function drawCalibScene() {
        if(calibCanvas.width !== CALIB.res) { calibCanvas.width = CALIB.res; calibCanvas.height = CALIB.res; }
        const ctx = calibCtx;
        const cx = CALIB.res/2, cy = CALIB.res/2;

        // 1. Clear
        ctx.fillStyle = '#050505'; ctx.fillRect(0,0,CALIB.res,CALIB.res);

        // 2. Draw "Data" (Red Rings) - ALL 11 RINGS
        const realRings = []; // Store for RMSE calculation
        ctx.strokeStyle = '#ff5252'; ctx.lineWidth = 2; ctx.shadowBlur = 4; ctx.shadowColor = '#cc0000';
        
        LaB6_D.forEach((d, i) => {
            const r = calculateRingRadius(d, CALIB.lambda, CALIB.realSDD, CALIB.pixelSize);
            realRings.push(r);
            if(r < CALIB.res) { 
                ctx.beginPath(); 
                ctx.arc(cx, cy, r, 0, Math.PI*2); 
                // Slight transparency for outer rings
                ctx.globalAlpha = i < 5 ? 1.0 : 0.6;
                ctx.stroke(); 
                ctx.globalAlpha = 1.0;
            }
        });
        ctx.shadowBlur = 0; ctx.lineWidth = 1;

        // 3. Calculate "Fit" (Green Rings) - LIMIT TO FIRST 5
        const inputR1 = parseFloat(document.getElementById('calibRadiusSlider').value);
        
        // Reverse engineer SDD from Ring 1
        const theta1 = Math.asin(CALIB.lambda / (2 * LaB6_D[0]));
        const currentCalcSDD = (inputR1 * CALIB.pixelSize) / Math.tan(2 * theta1);
        
        // Calculate fit rings (ONLY 5)
        const fitRings = [];
        ctx.strokeStyle = '#66ff66'; ctx.setLineDash([4, 4]); ctx.lineWidth = 2;
        for(let i=0; i<5; i++) {
            const d = LaB6_D[i];
            const r = calculateRingRadius(d, CALIB.lambda, currentCalcSDD, CALIB.pixelSize);
            fitRings.push(r);
            if(r < CALIB.res) { ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.stroke(); }
        }
        ctx.setLineDash([]);

        // 4. Update UI Values
        document.getElementById('mathRes').innerText = Math.round(currentCalcSDD);

        // 5. Calculate RMSE based on VISIBLE 5 RINGS ONLY
        let sumSq = 0;
        let count = 0;
        for(let i=0; i<5; i++) {
            // Compare fit ring [i] vs real ring [i]
            // Ensure real ring corresponds to same index
            if(realRings[i] < CALIB.res * 1.5) { 
                const diff = fitRings[i] - realRings[i];
                sumSq += diff * diff;
                count++;
            }
        }
        const rmse = count > 0 ? Math.sqrt(sumSq / count) : 0;
        
        const rmseEl = document.getElementById('rmseVal');
        rmseEl.innerText = rmse.toFixed(2) + " px";
        
        if(rmse < 1.0) rmseEl.className = "error-value status-good";
        else if(rmse < 5.0) rmseEl.className = "error-value status-warn";
        else rmseEl.className = "error-value status-bad";
    }

    function checkCalibration() {
        const inputR1 = parseFloat(document.getElementById('calibRadiusSlider').value);
        const theta1 = Math.asin(CALIB.lambda / (2 * LaB6_D[0]));
        const currentCalcSDD = (inputR1 * CALIB.pixelSize) / Math.tan(2 * theta1);
        
        const errPct = Math.abs(currentCalcSDD - CALIB.realSDD)/CALIB.realSDD * 100;
        const fb = document.getElementById('calibFeedback');
        
        let msg = "";
        if(LANG==='cn') msg = `ÁúüÂÆûË∑ùÁ¶ª: ${CALIB.realSDD} mm<br>‰Ω†ÁöÑÁªìÊûú: ${Math.round(currentCalcSDD)} mm`;
        else msg = `Actual: ${CALIB.realSDD} mm<br>Calculated: ${Math.round(currentCalcSDD)} mm`;

        if(errPct < 0.5) fb.innerHTML = `<span style="color:#66ff66; font-weight:bold;">Excellent! Error ${errPct.toFixed(2)}%</span><br><small>${msg}</small>`;
        else if(errPct < 2.0) fb.innerHTML = `<span style="color:#ffdb58;">Good. Error ${errPct.toFixed(2)}%</span><br><small>${msg}</small>`;
        else fb.innerHTML = `<span style="color:#ff5252;">Keep trying. Error ${errPct.toFixed(2)}%</span><br><small>${msg}</small>`;
    }


    // ================== UTILS ==================
    function switchTab(mode) {
        document.getElementById('tabSim').className = mode === 'sim' ? 'tab-btn active' : 'tab-btn';
        document.getElementById('tabCalib').className = mode === 'calib' ? 'tab-btn active' : 'tab-btn';
        document.getElementById('viewSim').className = mode === 'sim' ? 'main-container active-view' : 'main-container';
        document.getElementById('viewCalib').className = mode === 'calib' ? 'main-container active-view' : 'main-container';

        if(mode === 'sim') updateSim();
        else { if(CALIB.realSDD === 0) startNewCalibration(); drawCalibScene(); }
    }

    function toggleLang() {
        LANG = LANG === 'en' ? 'cn' : 'en';
        const t = TXT[LANG];
        document.getElementById('tabSim').innerText = t.tabSim;
        document.getElementById('tabCalib').innerText = t.tabCalib;
        document.getElementById('secSource').innerText = t.secSource;
        document.getElementById('lblWavelength').innerText = t.lblWavelength;
        document.getElementById('lblSample').innerText = t.lblSample;
        document.getElementById('secDetector').innerText = t.secDetector;
        document.getElementById('lblResolution').innerText = t.lblResolution;
        document.getElementById('lblPixelSize').innerText = t.lblPixelSize;
        document.getElementById('lblSDD').innerText = t.lblSDD;
        document.getElementById('btnReset').innerText = t.btnReset;
        document.getElementById('tipDrag').innerText = t.tipDrag;
        document.getElementById('calibGoalTitle').innerText = t.calibGoalTitle;
        document.getElementById('calibDesc').innerText = t.calibDesc;
        document.getElementById('btnNewProblem').innerText = t.btnNewProblem;
        document.getElementById('calibStepTitle').innerText = t.calibStepTitle;
        document.getElementById('lblSlider').innerText = t.lblSlider;
        document.getElementById('btnCheck').innerText = t.btnCheck;
        document.getElementById('rmseDesc').innerText = t.rmseDesc;
        const legs = document.querySelectorAll('.legend-item');
        legs[0].innerHTML = `<div class="dot" style="background:#ff5252;"></div> ${t.legendData}`;
        legs[1].innerHTML = `<div class="dot" style="background:#66ff66;"></div> ${t.legendFit}`;
    }

    switchTab('sim');
    if (navigator.language.startsWith('zh')) toggleLang();

</script>

<footer style="text-align: center; padding: 10px; background-color: #1f2833; color: #888; font-size: 0.85rem; border-top: 1px solid #333; margin-top: 0;">
    ¬© 2026 @hellowei.cn
</footer>

</body>
</html>